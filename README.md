# CVE-2021-27239
nDay exploit for CVE-2021-27239

## Background
> This vulnerability allows network-adjacent attackers to execute arbitrary code on affected installations of NETGEAR R6400 and R6700 routers. Authentication is not required to exploit this vulnerability.
The specific flaw exists within the upnpd service, which listens on UDP port 1900 by default. A crafted MX header field in an SSDP message can trigger an overflow of a fixed-length stack-based buffer. An attacker can leverage this vulnerability to execute code in the context of root.

## Resources
- [ZDI Advisory](https://www.zerodayinitiative.com/advisories/ZDI-21-206/)
- [CVE Details](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27239)
- [Netgear Security Advisory](https://kb.netgear.com/000062820/Security-Advisory-for-Stack-based-Buffer-Overflow-Remote-Code-Execution-Vulnerability-on-Some-Routers-PSV-2020-0432)

## Setup
Follow this gist to get Qemu setup
- [Qemu Setup](https://gist.github.com/WizardsOfTheInternet/111139c9afe65482ebf3d9d39b89e555)

## Research

### Patch Diffing
The vulnerability exists in the Netgear R8000 device, for firmware versions before `1.0.4.68`. We can download the previous firmware version to this, `1.0.4.66` and try to find what was changed in the `upnpd` binary to fix the vulnerability.

**Unpacking Firmware**
```
binwalk -e R8000-V1.0.4.66_10.1.75.chk

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
58            0x3A            TRX firmware header, little endian, image size: 30261248 bytes, CRC32: 0x60B59DD5, flags: 0x0, version: 1, header size: 28 bytes, loader offset: 0x1C, linux kernel offset: 0x1F52F4, rootfs offset: 0x0
86            0x56            LZMA compressed data, properties: 0x5D, dictionary size: 65536 bytes, uncompressed size: 5042304 bytes
2052910       0x1F532E        Squashfs filesystem, little endian, version 4.0, compression:xz, size: 28202885 bytes, 1713 inodes, blocksize: 131072 bytes, created: 2020-11-18 01:45:20

# squashfs-root
bin  data  dev  etc  lib  media  mnt  opt  proc  sbin  share  sys  tmp  usr  var  www
```
If you fail to unpack the firmware because of an error to do with `sassquatch` then make sure you install the following:

```
# Install sasquatch to extract non-standard SquashFS images
sudo apt-get install zlib1g-dev liblzma-dev liblzo2-dev
git clone https://github.com/devttys0/sasquatch
(cd sasquatch && ./build.sh)
```
More information can be found here: [Install Binwalk](https://github.com/ReFirmLabs/binwalk/blob/master/INSTALL.md)

**Ghidra**

We can analyize both the `upnpd` binaries found in firmware versions `1.0.4.68` and `1.0.4.66` in Ghidra.

> A crafted MX header field in an SSDP message

We can search for strings related to processing `SSDP` packets, specifically `MX` headers.

